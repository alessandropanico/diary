<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title class="ff7-title">Profilo Utente</ion-title>
  </ion-toolbar>
</ion-header>

<div class="content">

  <div *ngIf="isLoading" class="loading-overlay">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Caricamento profilo...</p>
  </div>

  <div *ngIf="!isLoading && profileData">
    <div class="profile-banner-container">
      <img [src]="profileData.banner || 'assets/immaginiGenerali/default-banner.jpg'" alt="Banner Profilo"
        class="profile-banner" />
    </div>

    <div class="avatar-wrapper">
      <ion-avatar class="profile-avatar">
        <img [src]="getUserPhoto(profileData.photo)" alt="Foto profilo" />
      </ion-avatar>

      <app-emoji-status [status]="profileData.status || ''" [editing]="false"></app-emoji-status>
    </div>

    <div class="profile-view">
      <h2>{{ profileData.nickname || 'Nickname non disponibile' }}</h2>
      <h3>{{ profileData.name || 'Nome e Cognome non disponibili' }}</h3>

      <div class="level-compact-info">
        <span class="level-label">Livello</span>
        <span class="level-number">{{ targetUserLevel }}</span>
        <div class="xp-bar-compact-container">
          <div class="xp-bar-compact" [style.width]="targetXpPercentage + '%'"></div>
        </div>
        <span class="xp-compact-text">{{ targetUserXP }} / {{ targetXpForNextLevel }} XP</span>
      </div>

      <p>{{ profileData.bio || 'Descrizione assente' }}</p>
      <p *ngIf="profileData.link">
        <a [href]="profileData.link" target="_blank" rel="noopener noreferrer">
          {{ profileData.linkText || profileData.link }}
        </a>
      </p>

      <div class="follow-stats-wrapper">
        <div *ngIf="isLoadingStats" class="loading-stats-local-overlay">
          <ion-spinner name="crescent" color="primary"></ion-spinner>
        </div>
        <div class="follow-stats" [class.hidden]="isLoadingStats">
          <div class="stat-item clickable-stat" (click)="goToFollowersList()">
            <strong>{{ targetUserFollowersCount }}</strong>
            <span>Follower</span>
          </div>
          <div class="stat-item clickable-stat" (click)="goToFollowingList()">
            <strong>{{ targetUserFollowingCount }}</strong>
            <span>Seguiti</span>
          </div>
        </div>
      </div>

      <div class="profile-actions">
        <ion-button *ngIf="loggedInUserId && loggedInUserId !== profileData.uid" expand="block"
          [class.follow-button]="!isFollowingUser" [class.unfollow-button]="isFollowingUser" (click)="toggleFollow()">
          {{ isFollowingUser ? 'Non seguire più' : 'Segui' }}
        </ion-button>

        <ion-button *ngIf="loggedInUserId && loggedInUserId !== profileData.uid" expand="block"
          class="ff7-button message-button" (click)="startChat()">
          Messaggia
        </ion-button>
      </div>

      <div class="profile-actions2">
        <ion-button *ngIf="loggedInUserId && loggedInUserId !== profileData.uid" expand="block"          
          [color]="isUserBlockedByMe ? 'medium' : 'danger'" (click)="toggleBlockUser()">
                    {{ isUserBlockedByMe ? 'Sblocca Utente' : 'Blocca Utente' }}
                  </ion-button>
      </div>

      <div class="profile-content-switcher">
        <div class="ff7-toggle-buttons">
          <ion-button (click)="selectedSegment = 'posts'" [class.active]="selectedSegment === 'posts'"
            class="ff7-toggle-button" fill="clear" expand="block">
            Post
          </ion-button>
          <ion-button (click)="selectedSegment = 'dashboard'" [class.active]="selectedSegment === 'dashboard'"
            class="ff7-toggle-button" fill="clear" expand="block">
            Informazioni
          </ion-button>
          <div class="toggle-indicator" [class.shift-right]="selectedSegment === 'dashboard'"></div>
        </div>

        <div>
          <div *ngIf="selectedSegment === 'posts'" class="content-fade-in">
            <app-user-posts [userId]="profileData.uid"></app-user-posts>
          </div>
          <div *ngIf="selectedSegment === 'dashboard'" class="content-fade-in">
            <app-user-dashboard [userId]="profileData.uid"></app-user-dashboard>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
